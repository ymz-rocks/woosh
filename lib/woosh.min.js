/* Woosh v1.0, @license MIT */
"use strict";(function(){function t(){function o(){return{on:{listen:function(n,i){if(i instanceof Function){t[n]instanceof Object||(t[n]={});let r=parseInt(Math.random()*1e9);return t[n][r]=i,function(){t[n]&&delete t[n][r]}}},trigger:function(n,i){t[n]instanceof Object&&(i instanceof Function||(i=function(){}),Object.keys(t[n]).forEach(function(r){t[n][r].call(f,i)}))}}}}function u(n){return function(){return!0}}function s(n){!n instanceof Function||n(f)}function h(n,t,i){return new Promise(function(r,u){c[n].partialify(t,i).then(function(){s(r)},u)})}var f=this,i=o(),e,t={},c={pages:new r(this,i,u,!0)};this.use={};this.events=new n(i.on).use;this.services=new n(i.services,undefined,undefined,u()).use;this.language=function(n){if(arguments.length==0)return e;e=n};this.pagination=function(n,t){return h("pages",n,t)};this.reload=function(t){this.model=new n(i.model=t,undefined,undefined,u()).use;this.use.shared={context:{events:this.events,model:this.model,services:this.services,language:this.language}}}}function i(n,t){function u(){return document.querySelector("app")}function o(n){function s(i,r){t[i]=Object.assign(n.pages[i],{name:i,tag:i+"-page",url:"pages/"+n.pages[i].view,render:function(){var n=document.createElement("div");r.appendChild(n);this.element=n}});t[i].render()}var e=u(),t={},h,o,r,f;if(!e||(h=e.querySelector("router"),!h))return t;r=e.querySelectorAll("route");for(let t=0;t<r.length;t++){let i=r[t].getAttribute("path").split("/")[0];n.pages[i]&&s(i,r[t]);(!i||i.length&&i.length==0)&&(o=r[t])}if(!o)return t;for(f in i.config.pages)if(n.pages[f]instanceof Object&&n.pages[f]["default"])return s(f,o),t[""]=t[f],t;return t}var i=this,r,e;this.boot=function(){function r(){return t.core.dynamix(i.config.boot.components,"components",n.model)}function s(){return new Promise(function(r,u){if(n.reload({}),riot.mixin("global-context",n.use.shared),!i.config.boot.model)return r();var f=Array.isArray(i.config.boot.model)?i.config.boot.model:[i.config.boot.model];if(f.length==0)return r();Promise.all(f.map(function(n){return t.async.json(n,{cache:!0})})).then(function(t){t.forEach(function(t){t instanceof Object&&Object.assign(n.model,t);var i=n.language();i&&n.model[i]instanceof Object&&Object.assign(n.model.lang={},n.model[i])});r()},u)})}function h(){return t.core.statix(i.config.boot.services,"services")}function c(){return t.core.statix(i.config.boot.styles,"styles")}function l(){return t.core.dynamix(i.config.boot.widgets,"widgets")}function a(){return new Promise(function(t){riot.compile(function(){riot.mount("router");e=o(i.config)});t(n)})}var v=u();return new Promise(function(u,e){if(!v)return e("app element is required");t.async.json("config.json").then(function(o){if(!(o instanceof Object))return e("configuration object is missing");if(!(o.pages instanceof Object))return e("`pages` section is missing in configuration object");o.boot instanceof Object||(o.boot={});o.boot.components instanceof Object||(o.boot.components={});o.boot.services instanceof Object||(o.boot.services={});o.boot.widgets instanceof Object||(o.boot.widgets={});t.core=new f(n,i.config=o,t);n.initialize instanceof Function&&n.initialize(n);s().then(c).then(h).then(r).then(l).then(a).then(u,e)},console.error)})};this.page=function(n){return new Promise(function(i,u){function s(){return typeof f.model=="string"?t.async.json(f.model).then(o):Array.isArray(f.model)?new Promise(function(n,i){Promise.all(f.model.map(function(n){return t.async.json(n)})).then(function(t){f.model={};t.forEach(function(n){f.model=Object.assign(f.model,n)});o(f.model).then(n,i)},i)}):f.model instanceof Object?o(f.model,!0):void 0}function o(n,i){function u(){return new Promise(function(u,e){i&&f.render();t.core.dynamix([f],"pages",n).then(function(n){r=n[0];u()},e)})}function e(){return t.core.dynamix(f.components||[],"components")}function o(){return t.core.dynamix(f.widgets||[],"widgets")}return u().then(o).then(e)}r&&r.unmount();var f=e[n];if(!f)return u(t.text.format("`*` page is not registered",f.name));if(!f.hasOwnProperty("model"))return u("every page must include a model property with a valid url as value");s().then(i,u)})}}function n(n,t,i,r){t instanceof Function||(t=function(){});i instanceof Function||(i=function(){return!0});r instanceof Function||(r=function(){return!0});var u=n||{},f=new Proxy(u,{get:function(n,i){var r=t(n,i);return r===undefined?n[i]:r},set:function(n,t,u){return u==n[t]?!0:i(n,t,u,n[t])?r(n,t,n[t]=u):!1}});this.use=f}function r(t,i){var r={ready:{},handlers:{}};Object.defineProperty(this,"handlers",{get:function(){return r.handlers}});Object.defineProperty(this,"state",{get:function(){return r.ready}});this.partialify=function(u,f){return new Promise(function(e){var o=u.tag||u.name;r.ready[o]=!1;Array.isArray(r.handlers[o])||(r.handlers[o]=[]);i[o]={model:f===!0?{}:f,on:{ready:function(n){r.ready[o]=(new Date).getTime();r.handlers[o].push(n);n.update();e()}}};t.use[o]={events:new n(i[o].on).use,model:f?new n(i[o].model).use:undefined}})}}function u(){var n=this,t={},i=this.Request=function(n){if(n instanceof Object){var i=new XMLHttpRequest;if(i)return new Promise(function(r,u){if(n.cache&&t[n.url])return r(t[n.url]);i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&(i.status==200?(n.cache&&(t[n.url]=i),r(i)):u(i))};i.open(n.method,n.url);i.send.apply(i,n.data?[n.data]:undefined)})}};this.content=function(n,t){return new Promise(function(r,u){new i(Object.assign({method:"GET",url:n},t)).then(function(n){r(t&&t.format instanceof Function?t.format(n.responseText):n.responseText)},u)})};this.json=function(t,i){return new Promise(function(r,u){n.content(t,i).then(function(n){r(JSON.parse(n))},u)})};this.script=function(t,i){return new Promise(function(r,u){n.content(t,i).then(function(n){var e="script",t=document.createElement(e),f;t.type=i.type||"text/javascript";t.innerHTML="\n"+n+"\n";f=document.getElementsByTagName(e)[0];f||u();f.parentNode.appendChild(t);r(t)},u)})};this.style=function(t,i){return new Promise(function(r,u){n.content(t,i).then(function(n){var t=document.createElement("style"),i;if(t.setAttribute("type","text/css"),t.innerHTML=n,i=document.getElementsByTagName("head")[0],!i)return u();i.appendChild(t);r(t)},u)})}}function f(n,t,i){function e(n,t){var f=Object.assign({},u),e;return f.start=Object.assign({},u.start),e=t=="widgets"||!r?"":i.text.format('this.mixin("*");this.events.ready(this);',r.tag),f.start.value=i.text.format(f.start.value,e,n.name),f}function f(n,r,u){return new Promise(function(f,e){if(!(t instanceof Object))return e("configuration object is missing");if(!Array.isArray(n))return e("array of names is required");var o=[];n.forEach(function(n){if(typeof t[r][n]=="string")return o.push(t[r][n]);if(!(t[r][n]instanceof Object))return e(i.text.format("configuartion for `*` in `*` section is missing",n,r));Object.assign(t[r][n],{url:r+"/"+t[r][n].path,dependencies:t[r][n].dependencies||[]});t[r][n][n.indexOf("-")?"tag":"name"]=n;o.push(t[r][n])});u(o,f,e)})}var u={start:{expression:"<script>",value:'this.mixin("global-context");*;function initialize(context,*,remote,attr){var language=context.language();if(language&&ctx.model instanceof Object&&ctx.model[language] instanceof Object)Object.assign(ctx.model.lang={},ctx.model[language]);'},end:{value:'};var ctx=this,attr=function(name, value){if(arguments.length==1)return opts.hasOwnProperty(name)?opts[name]:undefined;opts[name]=value},bind=this.bind=function(name,value){var key=attr(name);if(key===undefined)return;var contextify=attr("contextify");var model=contextify!==undefined&&contextify!==false?ctx.context.model:ctx.model;if(!model)return;if(arguments.length==1)return ctx.context.services.core.bind(model,key);ctx.context.services.core.bind(model,key,value)};initialize(this.context,this,function(){return ctx.context.services.remote.attach(ctx)});'}},o={components:"componentify",widgets:"widgetize"},r;u.end.expression=u.start.expression[0]+"/"+u.start.expression.substr(1);this.bind=function(n,t,i){var r=n,u=t.split("."),f=u.length-1;for(let n=0;n<f;n++){if(!r[u[n]])break;r=r[u[n]]}return(t=u[f],arguments.length==2)?r[t]:(r[t]=i,!0)};this.dynamix=function(t,u,s){function h(t,f){function o(i){var u;return new Promise(function(e){riot.compile(i,function(){if(f===!0)n.pagination.call(n,t,s).then(function(){}),riot.mixin(t.tag,n.use[t.tag]),u=riot.mount(t.element,t.tag);else if(f&&r){riot.mixin(r.tag,n.use[r.tag]);let i=r.element.querySelectorAll(t.tag);for(let n=0;n<i.length;n++)riot.mount(i[n],t.tag)}e(u)})})}function h(){return i.async.content(t.url,{cache:!0,format:function(n){f===!0&&(r=t);var o=e(t,u);return o?i.text.inject(n,o.start,o.end):n}})}return new Promise(function(n,r){if(!(t instanceof Object))return r(i.text.format("missing configuration for `*`!",name));h().then(o).then(n,r)})}return u=="pages"?h(Object.assign(t[0],{model:s}),!0):f(t,u,function(n,t,i){var f=[];n.forEach(function(n){n.page=r;f.push(h(n,o[u]))});Promise.all(f).then(t,i)})};this.statix=function(r,u){function e(r){function u(n){return i.async.script(n.url,{cache:!0,format:function(t){return i.text.format('woosh.service("*",*);',n.tag,t)}})}return new Promise(function(f,e){Array.isArray(r)||e();var o=r.map(u);if(o.length==0)return f();Promise.all(o).then(function(){Object.keys(i).forEach(function(t){n.services[t]=i[t]});Object.keys(t.services).forEach(function(t){var r=woosh.service(t);r?n.services[t]=new r(n):console.warn(i.text.format("`*` service fail to load. please check your `boot` configuration",t))});f()},e)})}function o(n){function t(n){return i.async.style(n,{cache:!0})}return new Promise(function(i,r){Array.isArray(n)||r();var u=n.map(t);if(u.length==0)return i();Promise.all(u).then(i,r)})}return f(r,u,function(n,t,r){var f;switch(u){case"services":f=e;break;case"styles":f=o}if(f)return f(n).then(t,r);r(i.text.format("type `*` is not defined",u))})}}function e(){var n={};this.attach=function(t){var i=parseInt(Math.random()*1e9);return{activate:function(){if(n[i])return n[i].apply(t,arguments)},remote:function(t){n[i]=t}}};this.register=function(n,t,i){n.opts[t]instanceof Function&&n.opts[t](i)}}function o(){var t="*",n="\n",i=" ";Object.defineProperty(this,"newline",{get:function(){return n}});this.between=function(n,t,i,r){var u=n.indexOf(t,r),f=n.indexOf(i,r);if(u>-1&&f>-1)return u++,n.substr(u,f-u)};this.format=function(n){var i=n;for(let n=1;n<arguments.length;n++)i=i.replace(t,arguments[n]);return i};this.inject=function(n,t,i){return!(t instanceof Object)||!(i instanceof Object)?n:(i.index=n.indexOf(i.expression),t.index=n.indexOf(t.expression),i.index<0||t.index<0)?n:(t.index+=t.expression.length,this.line(n.substr(0,t.index),t.value,n.substring(t.index,i.index),i.value,n.substr(i.index)))};this.join=function(n){return Array.prototype.join.call(arguments,n)};this.line=function(){return Array.prototype.join.call(arguments,n)};this.space=function(){return Array.prototype.join.call(arguments,i)}}function s(){var n={};this.empty=function(t){return!Array.isArray(n[t])||n[t].length==0};this.trigger=function(t,i){if(this.empty(t))return!1;var r=this;return n[t].forEach(function(n){n.call(i||r)}),delete n[t],!0};this.when=function(t,i){Array.isArray(n[t])||(n[t]=[]);i instanceof Function&&n[t].push(i)}}function h(){function c(n,t){Object.defineProperty(this,"action",{get:function(){return t}});Object.defineProperty(this,"page",{get:function(){return n}});Object.defineProperty(this,"query",{get:function(){var n=route.query();return Object.keys(n).length>0?n:undefined}});this.load=function(){return r.page(this.page)}}var f={async:new u,remote:new e,text:new o,wait:new s},n=new t(f),r=new i(n,f),h={services:{}};this.start=function(t){return(n.initialize=t,document.readyState=="complete")?r.boot():new Promise(function(n,t){window.addEventListener("load",function(){r.boot().then(n,t)})})};this.service=function(n,t){if(arguments.length==1)return h.services[n];t instanceof Function&&(h.services[n]=t)};route(function(t,i){var r=new c(t,i);r.load().then(function(){n.use.shared.context.route=r;n.use.shared.context.events.trigger("app_route")},console.error)})}window.woosh=new h})()